-- ===========================================
-- 令和7年（2025年）度源泉征收税等级表
-- 用于源泉征收税的计算
-- ===========================================

-- 创建源泉征收税等级表
CREATE TABLE withholding_tax_bracket (
    id BIGSERIAL PRIMARY KEY,
    min_amount INTEGER NOT NULL,
    max_amount INTEGER NOT NULL,
    tax_amount_ko INTEGER,
    tax_amount_otsu INTEGER,
    calculation_formula TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加表注释
COMMENT ON TABLE withholding_tax_bracket IS '令和7年（2025年）度源泉征收税等级表，用于源泉征收税的计算';
COMMENT ON COLUMN withholding_tax_bracket.min_amount IS '扣除社会保险费后的工资金额最小值';
COMMENT ON COLUMN withholding_tax_bracket.max_amount IS '扣除社会保险费后的工资金额最大值（999999999表示无上限）';
COMMENT ON COLUMN withholding_tax_bracket.tax_amount_ko IS '甲类税额（有配偶和抚养人的情况）';
COMMENT ON COLUMN withholding_tax_bracket.tax_amount_otsu IS '乙类税额（单身等情况）';
COMMENT ON COLUMN withholding_tax_bracket.calculation_formula IS '计算公式（当税额需要计算时使用）';

-- 创建索引
CREATE INDEX idx_withholding_tax_bracket_min_max ON withholding_tax_bracket(min_amount, max_amount);

-- 插入2025年度源泉征收税等级表数据（甲类税额）
-- 根据令和7年（2025年）度源泉征收税月额表
INSERT INTO withholding_tax_bracket (min_amount, max_amount, tax_amount_ko, tax_amount_otsu, calculation_formula) VALUES
(0, 88000, 0, 0, NULL),
(88000, 89000, 130, 3200, NULL),
(89000, 90000, 180, 3200, NULL),
(90000, 91000, 230, 3200, NULL),
(91000, 92000, 290, 3200, NULL),
(92000, 93000, 340, 3300, NULL),
(93000, 94000, 390, 3300, NULL),
(94000, 95000, 440, 3300, NULL),
(95000, 96000, 490, 3400, NULL),
(96000, 97000, 540, 3400, NULL),
(97000, 98000, 590, 3500, NULL),
(98000, 99000, 640, 3500, NULL),
(99000, 101000, 720, 3600, NULL),
(101000, 103000, 830, 3600, NULL),
(103000, 105000, 930, 3700, NULL),
(105000, 107000, 1030, 3800, NULL),
(107000, 109000, 1130, 3800, NULL),
(109000, 111000, 1240, 3900, NULL),
(111000, 113000, 1340, 4000, NULL),
(113000, 115000, 1440, 4100, NULL),
(115000, 117000, 1540, 4100, NULL),
(117000, 119000, 1640, 4200, NULL),
(119000, 121000, 1750, 4300, NULL),
(121000, 123000, 1850, 4400, NULL),
(123000, 125000, 1950, 4500, NULL),
(125000, 127000, 2050, 4600, NULL),
(127000, 129000, 2150, 4700, NULL),
(129000, 131000, 2260, 4800, NULL),
(131000, 133000, 2360, 4900, NULL),
(133000, 135000, 2460, 5000, NULL),
(135000, 137000, 2550, 5100, NULL),
(137000, 139000, 2610, 5200, NULL),
(139000, 141000, 2680, 5300, NULL),
(141000, 143000, 2740, 5400, NULL),
(143000, 145000, 2800, 5500, NULL),
(145000, 147000, 2860, 5600, NULL),
(147000, 149000, 2920, 5700, NULL),
(149000, 151000, 2980, 5800, NULL),
(151000, 153000, 3050, 5900, NULL),
(153000, 155000, 3120, 6000, NULL),
(155000, 157000, 3200, 6100, NULL),
(157000, 159000, 3270, 6200, NULL),
(159000, 161000, 3340, 6300, NULL),
(161000, 163000, 3410, 6400, NULL),
(163000, 165000, 3480, 6500, NULL),
(165000, 167000, 3550, 6600, NULL),
(167000, 169000, 3620, 6700, NULL),
(169000, 171000, 3700, 6800, NULL),
(171000, 173000, 3770, 6900, NULL),
(173000, 175000, 3840, 7000, NULL),
(175000, 177000, 3910, 7100, NULL),
(177000, 179000, 3980, 7200, NULL),
(179000, 181000, 4050, 7300, NULL),
(181000, 183000, 4120, 7400, NULL),
(183000, 185000, 4200, 7500, NULL),
(185000, 187000, 4270, 7600, NULL),
(187000, 189000, 4340, 7700, NULL),
(189000, 191000, 4410, 7800, NULL),
(191000, 193000, 4480, 7900, NULL),
(193000, 195000, 4550, 8000, NULL),
(195000, 197000, 4630, 8100, NULL),
(197000, 199000, 4700, 8200, NULL),
(199000, 201000, 4770, 8300, NULL),
(201000, 203000, 4840, 8400, NULL),
(203000, 205000, 4910, 8500, NULL),
(205000, 207000, 4980, 8600, NULL),
(207000, 209000, 5050, 8700, NULL),
(209000, 211000, 5130, 8800, NULL),
(211000, 213000, 5200, 8900, NULL),
(213000, 215000, 5270, 9000, NULL),
(215000, 217000, 5340, 9100, NULL),
(217000, 219000, 5410, 9200, NULL),
(219000, 221000, 5480, 9300, NULL),
(221000, 224000, 5560, 9400, NULL),
(224000, 227000, 5680, 9500, NULL),
(227000, 230000, 5780, 9600, NULL),
(230000, 233000, 5890, 9700, NULL),
(233000, 236000, 5990, 9800, NULL),
(236000, 239000, 6110, 9900, NULL),
(239000, 242000, 6210, 10000, NULL),
(242000, 245000, 6320, 10100, NULL),
(245000, 248000, 6420, 10200, NULL),
(248000, 251000, 6530, 10300, NULL),
(251000, 254000, 6640, 10400, NULL),
(254000, 257000, 6750, 10500, NULL),
(257000, 260000, 6850, 10600, NULL),
(260000, 263000, 6960, 10700, NULL),
(263000, 266000, 7070, 10800, NULL),
(266000, 269000, 7180, 10900, NULL),
(269000, 272000, 7280, 11000, NULL),
(272000, 275000, 7390, 11100, NULL),
(275000, 278000, 7490, 11200, NULL),
(278000, 281000, 7610, 11300, NULL),
(281000, 284000, 7710, 11400, NULL),
(284000, 287000, 7820, 11500, NULL),
(287000, 290000, 7920, 11600, NULL),
(290000, 293000, 8040, 11700, NULL),
(293000, 296000, 8140, 11800, NULL),
(296000, 299000, 8250, 11900, NULL),
(299000, 302000, 8420, 12000, NULL),
(302000, 305000, 8670, 12100, NULL),
(305000, 308000, 8910, 12200, NULL),
(308000, 311000, 9160, 12300, NULL),
(311000, 314000, 9400, 12400, NULL),
(314000, 317000, 9650, 12500, NULL),
(317000, 320000, 9890, 12600, NULL),
(320000, 323000, 10140, 12700, NULL),
(323000, 326000, 10380, 12800, NULL),
(326000, 329000, 10630, 12900, NULL),
(329000, 332000, 10870, 13000, NULL),
(332000, 335000, 11120, 13100, NULL),
(335000, 338000, 11360, 13200, NULL),
(338000, 341000, 11610, 13300, NULL),
(341000, 344000, 11850, 13400, NULL),
(344000, 347000, 12100, 13500, NULL),
(347000, 350000, 12340, 13600, NULL),
(350000, 353000, 12590, 13700, NULL),
(353000, 356000, 12830, 13800, NULL),
(356000, 359000, 13080, 13900, NULL),
(359000, 362000, 13320, 14000, NULL),
(362000, 365000, 13570, 14100, NULL),
(365000, 368000, 13810, 14200, NULL),
(368000, 371000, 14060, 14300, NULL),
(371000, 374000, 14300, 14400, NULL),
(374000, 377000, 14550, 14500, NULL),
(377000, 380000, 14790, 14600, NULL),
(380000, 383000, 15040, 14700, NULL),
(383000, 386000, 15280, 14800, NULL),
(386000, 389000, 15530, 14900, NULL),
(389000, 392000, 15770, 15000, NULL),
(392000, 395000, 16020, 15100, NULL),
(395000, 398000, 16260, 15200, NULL),
(398000, 401000, 16510, 15300, NULL),
(401000, 404000, 16750, 15400, NULL),
(404000, 407000, 17000, 15500, NULL),
(407000, 410000, 17240, 15600, NULL),
(410000, 413000, 17490, 15700, NULL),
(413000, 416000, 17730, 15800, NULL),
(416000, 419000, 17980, 15900, NULL),
(419000, 422000, 18220, 16000, NULL),
(422000, 425000, 18470, 16100, NULL),
(425000, 428000, 18710, 16200, NULL),
(428000, 431000, 18960, 16300, NULL),
(431000, 434000, 19210, 16400, NULL),
(434000, 437000, 19450, 16500, NULL),
(437000, 440000, 19700, 16600, NULL),
(440000, 443000, 20090, 16700, NULL),
(443000, 446000, 20580, 16800, NULL),
(446000, 449000, 21070, 16900, NULL),
(449000, 452000, 21560, 17000, NULL),
(452000, 455000, 22050, 17100, NULL),
(455000, 458000, 22540, 17200, NULL),
(458000, 461000, 23030, 17300, NULL),
(461000, 464000, 23520, 17400, NULL),
(464000, 467000, 24010, 17500, NULL),
(467000, 470000, 24500, 17500, NULL),
(470000, 473000, 24990, 17600, NULL),
(473000, 476000, 25480, 17700, NULL),
(476000, 479000, 25970, 17800, NULL),
(479000, 482000, 26460, 17900, NULL),
(482000, 485000, 26950, 18000, NULL),
(485000, 488000, 27440, 18100, NULL),
(488000, 491000, 27930, 18200, NULL),
(491000, 494000, 28420, 18300, NULL),
(494000, 497000, 28910, 18400, NULL),
(497000, 500000, 29400, 18500, NULL),
(500000, 503000, 29890, 18600, NULL),
(503000, 506000, 30380, 18700, NULL),
(506000, 509000, 30880, 18800, NULL),
(509000, 512000, 31370, 18900, NULL),
(512000, 515000, 31860, 19000, NULL),
(515000, 518000, 32350, 19100, NULL),
(518000, 521000, 32840, 19200, NULL),
(521000, 524000, 33330, 19300, NULL),
(524000, 527000, 33820, 19400, NULL),
(527000, 530000, 34310, 19500, NULL),
(530000, 533000, 34800, 19600, NULL),
(533000, 536000, 35290, 19700, NULL),
(536000, 539000, 35780, 19800, NULL),
(539000, 542000, 36270, 19900, NULL),
(542000, 545000, 36760, 20000, NULL),
(545000, 548000, 37250, 20100, NULL),
(548000, 551000, 37740, 20200, NULL),
(551000, 554000, 38280, 20300, NULL),
(554000, 557000, 38830, 20400, NULL),
(557000, 560000, 39380, 20500, NULL),
(560000, 563000, 39930, 20600, NULL),
(563000, 566000, 40480, 20700, NULL),
(566000, 569000, 41030, 20800, NULL),
(569000, 572000, 41590, 20900, NULL),
(572000, 575000, 42140, 21000, NULL),
(575000, 578000, 42690, 21100, NULL),
(578000, 581000, 43240, 21200, NULL),
(581000, 584000, 43790, 21300, NULL),
(584000, 587000, 44340, 21400, NULL),
(587000, 590000, 44890, 21500, NULL),
(590000, 593000, 45440, 21600, NULL),
(593000, 596000, 46000, 21700, NULL),
(596000, 599000, 46550, 21800, NULL),
(599000, 602000, 47100, 21900, NULL),
(602000, 605000, 47650, 22000, NULL),
(605000, 608000, 48200, 22100, NULL),
(608000, 611000, 48750, 22200, NULL),
(611000, 614000, 49300, 22300, NULL),
(614000, 617000, 49860, 22400, NULL),
(617000, 620000, 50410, 22500, NULL),
(620000, 623000, 50960, 22600, NULL),
(623000, 626000, 51510, 22700, NULL),
(626000, 629000, 52060, 22800, NULL),
(629000, 632000, 52610, 22900, NULL),
(632000, 635000, 53160, 23000, NULL),
(635000, 638000, 53710, 23100, NULL),
(638000, 641000, 54270, 23200, NULL),
(641000, 644000, 54820, 23300, NULL),
(644000, 647000, 55370, 23400, NULL),
(647000, 650000, 55920, 23500, NULL),
(650000, 653000, 56470, 23600, NULL),
(653000, 656000, 57020, 23700, NULL),
(656000, 659000, 57570, 23800, NULL),
(659000, 662000, 58130, 23900, NULL),
(662000, 665000, 58680, 24000, NULL),
(665000, 668000, 59230, 24100, NULL),
(668000, 671000, 59780, 24200, NULL),
(671000, 674000, 60330, 24300, NULL),
(674000, 677000, 60880, 24400, NULL),
(677000, 680000, 61430, 24500, NULL),
(680000, 683000, 61980, 24600, NULL),
(683000, 686000, 62540, 24700, NULL),
(686000, 689000, 63090, 24800, NULL),
(689000, 692000, 63640, 24900, NULL),
(692000, 695000, 64190, 25000, NULL),
(695000, 698000, 64740, 25100, NULL),
(698000, 701000, 65290, 25200, NULL),
(701000, 704000, 65840, 25300, NULL),
(704000, 707000, 66400, 25400, NULL),
(707000, 710000, 66960, 25500, NULL),
(710000, 713000, 67570, 25600, NULL),
(713000, 716000, 68180, 25700, NULL),
(716000, 719000, 68790, 25800, NULL),
(719000, 722000, 69410, 25900, NULL),
(722000, 725000, 70020, 26000, NULL),
(725000, 728000, 70630, 26100, NULL),
(728000, 731000, 71250, 26200, NULL),
(731000, 734000, 71860, 26300, NULL),
(734000, 737000, 72470, 26400, NULL),
(737000, 740000, 73080, 26500, NULL),
(740000, 780000, 73390, 26600, NULL),
(780000, 950000, 81560, 26700, NULL),
(950000, 1700000, 121480, 17500, NULL),
(1700000, 2170000, 374180, 17600, NULL),
(2170000, 2210000, 571570, NULL, '651,900円に、その月の社会保険料等控除後の給与等の金額のうち1,700,000円を超える金額の65.945％に相当する金額を加算した金額'),
(2210000, 2250000, 593340, NULL, '651,900円に、その月の社会保険料等控除後の給与等の金額のうち1,700,000円を超える金額の65.945％に相当する金額を加算した金額'),
(2250000, 3500000, 615120, NULL, '651,900円に、その月の社会保険料等控除後の給与等の金額のうち1,700,000円を超える金額の65.945％に相当する金額を加算した金額'),
(3500000, 999999999, NULL, NULL, '3,500,000円の場合の税額に、その月の社会保険料等控除後の給与等の金額のうち3,500,000円を超える金額の45.945％に相当する金額を加算した金額');

-- 创建触发器函数，用于自动更新 updated_at 字段
-- 注意：函数已在V1脚本中创建，这里不需要再次创建

-- 创建触发器
DROP TRIGGER IF EXISTS update_withholding_tax_bracket_updated_at ON withholding_tax_bracket;
CREATE TRIGGER update_withholding_tax_bracket_updated_at
    BEFORE UPDATE ON withholding_tax_bracket
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

