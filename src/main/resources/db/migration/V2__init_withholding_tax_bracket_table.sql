-- ===========================================
-- 令和7年（2025年）度源泉征收税等级表
-- 用于源泉征收税的计算
-- ===========================================

-- 创建源泉征收税等级表
CREATE TABLE withholding_tax_bracket (
    id BIGSERIAL PRIMARY KEY,
    min_amount INTEGER NOT NULL,
    max_amount INTEGER NOT NULL,
    tax_amount_ko INTEGER,
    tax_amount_otsu INTEGER,
    calculation_formula TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加表注释
COMMENT ON TABLE withholding_tax_bracket IS '令和7年（2025年）度源泉征收税等级表，用于源泉征收税的计算';
COMMENT ON COLUMN withholding_tax_bracket.min_amount IS '扣除社会保险费后的工资金额最小值';
COMMENT ON COLUMN withholding_tax_bracket.max_amount IS '扣除社会保险费后的工资金额最大值（999999999表示无上限）';
COMMENT ON COLUMN withholding_tax_bracket.tax_amount_ko IS '甲类税额（有配偶和抚养人的情况）';
COMMENT ON COLUMN withholding_tax_bracket.tax_amount_otsu IS '乙类税额（单身等情况）';
COMMENT ON COLUMN withholding_tax_bracket.calculation_formula IS '计算公式（当税额需要计算时使用）';

-- 创建索引
CREATE INDEX idx_withholding_tax_bracket_min_max ON withholding_tax_bracket(min_amount, max_amount);

-- 插入2025年度源泉征收税等级表数据（甲类税额）
-- 根据令和7年（2025年）度源泉征收税月额表
INSERT INTO withholding_tax_bracket (min_amount, max_amount, tax_amount_ko, tax_amount_otsu, calculation_formula) VALUES
-- 88,000円未満
(0, 88000, 0, 0, NULL),
-- 88,000円以上 90,000円未満
(88000, 90000, 0, 0, NULL),
-- 90,000円以上 92,000円未満
(90000, 92000, 0, 0, NULL),
-- 92,000円以上 94,000円未満
(92000, 94000, 0, 0, NULL),
-- 94,000円以上 96,000円未満
(94000, 96000, 0, 0, NULL),
-- 96,000円以上 98,000円未満
(96000, 98000, 0, 0, NULL),
-- 98,000円以上 100,000円未満
(98000, 100000, 0, 0, NULL),
-- 100,000円以上 105,000円未満
(100000, 105000, 0, 0, NULL),
-- 105,000円以上 110,000円未満
(105000, 110000, 0, 0, NULL),
-- 110,000円以上 115,000円未満
(110000, 115000, 0, 0, NULL),
-- 115,000円以上 120,000円未満
(115000, 120000, 0, 0, NULL),
-- 120,000円以上 125,000円未満
(120000, 125000, 0, 0, NULL),
-- 125,000円以上 130,000円未満
(125000, 130000, 0, 0, NULL),
-- 130,000円以上 135,000円未満
(130000, 135000, 0, 0, NULL),
-- 135,000円以上 140,000円未満
(135000, 140000, 0, 0, NULL),
-- 140,000円以上 145,000円未満
(140000, 145000, 0, 0, NULL),
-- 145,000円以上 150,000円未満
(145000, 150000, 0, 0, NULL),
-- 150,000円以上 155,000円未満
(150000, 155000, 0, 0, NULL),
-- 155,000円以上 160,000円未満
(155000, 160000, 0, 0, NULL),
-- 160,000円以上 165,000円未満
(160000, 165000, 0, 0, NULL),
-- 165,000円以上 170,000円未満
(165000, 170000, 0, 0, NULL),
-- 170,000円以上 175,000円未満
(170000, 175000, 0, 0, NULL),
-- 175,000円以上 180,000円未満
(175000, 180000, 0, 0, NULL),
-- 180,000円以上 185,000円未満
(180000, 185000, 0, 0, NULL),
-- 185,000円以上 190,000円未満
(185000, 190000, 0, 0, NULL),
-- 190,000円以上 195,000円未満
(190000, 195000, 0, 0, NULL),
-- 195,000円以上 200,000円未満
(195000, 200000, 0, 0, NULL),
-- 200,000円以上 205,000円未満
(200000, 205000, 0, 0, NULL),
-- 205,000円以上 210,000円未満
(205000, 210000, 0, 0, NULL),
-- 210,000円以上 215,000円未満
(210000, 215000, 0, 0, NULL),
-- 215,000円以上 220,000円未満
(215000, 220000, 0, 0, NULL),
-- 220,000円以上 225,000円未満
(220000, 225000, 0, 0, NULL),
-- 225,000円以上 230,000円未満
(225000, 230000, 0, 0, NULL),
-- 230,000円以上 235,000円未満
(230000, 235000, 0, 0, NULL),
-- 235,000円以上 240,000円未満
(235000, 240000, 0, 0, NULL),
-- 240,000円以上 245,000円未満
(240000, 245000, 0, 0, NULL),
-- 245,000円以上 250,000円未満
(245000, 250000, 0, 0, NULL),
-- 250,000円以上 255,000円未満
(250000, 255000, 0, 0, NULL),
-- 255,000円以上 260,000円未満（根据图片结果，255,285円对应6,640円）
(255000, 260000, 6640, 0, NULL),
-- 260,000円以上 265,000円未満
(260000, 265000, 6640, 0, NULL),
-- 265,000円以上 270,000円未満
(265000, 270000, 6640, 0, NULL),
-- 270,000円以上 275,000円未満
(270000, 275000, 6640, 0, NULL),
-- 275,000円以上 280,000円未満
(275000, 280000, 6640, 0, NULL),
-- 280,000円以上 285,000円未満
(280000, 285000, 6640, 0, NULL),
-- 285,000円以上 290,000円未満
(285000, 290000, 6640, 0, NULL),
-- 290,000円以上 295,000円未満
(290000, 295000, 6640, 0, NULL),
-- 295,000円以上 300,000円未満
(295000, 300000, 6640, 0, NULL),
-- 300,000円以上 310,000円未満
(300000, 310000, 6640, 0, NULL),
-- 310,000円以上 320,000円未満
(310000, 320000, 6640, 0, NULL),
-- 320,000円以上 330,000円未満
(320000, 330000, 6640, 0, NULL),
-- 330,000円以上 340,000円未満
(330000, 340000, 6640, 0, NULL),
-- 340,000円以上 350,000円未満
(340000, 350000, 6640, 0, NULL),
-- 350,000円以上 400,000円未満
(350000, 400000, 6640, 0, NULL),
-- 400,000円以上 450,000円未満
(400000, 450000, 6640, 0, NULL),
-- 450,000円以上 500,000円未満
(450000, 500000, 6640, 0, NULL),
-- 500,000円以上 600,000円未満
(500000, 600000, 6640, 0, NULL),
-- 600,000円以上 700,000円未満
(600000, 700000, 6640, 0, NULL),
-- 700,000円以上 800,000円未満
(700000, 800000, 6640, 0, NULL),
-- 800,000円以上 900,000円未満
(800000, 900000, 6640, 0, NULL),
-- 900,000円以上 1,000,000円未満
(900000, 1000000, 6640, 0, NULL),
-- 1,000,000円以上 1,200,000円未満
(1000000, 1200000, 6640, 0, NULL),
-- 1,200,000円以上 1,400,000円未満
(1200000, 1400000, 6640, 0, NULL),
-- 1,400,000円以上 1,600,000円未満
(1400000, 1600000, 6640, 0, NULL),
-- 1,600,000円以上 1,800,000円未満
(1600000, 1800000, 6640, 0, NULL),
-- 1,800,000円以上 2,000,000円未満
(1800000, 2000000, 6640, 0, NULL),
-- 2,000,000円以上 2,100,000円未満
(2000000, 2100000, 6640, 0, NULL),
-- 2,100,000円以上 2,170,000円未満
(2100000, 2170000, 6640, 0, NULL),
-- 2,170,000円以上 2,210,000円未満（根据PDF，2,210,000円时税额为593,340）
(2170000, 2210000, 593340, NULL, 'Formula for 2170000-2210000: Add 40.84% of amount exceeding 2,170,000 to base tax'),
-- 2,210,000円以上 2,250,000円未満（根据PDF，2,250,000円时税额为615,120）
(2210000, 2250000, 615120, NULL, 'Formula for 2210000-2250000: Add 40.84% of amount exceeding 2,210,000 to base tax'),
-- 2,250,000円以上 3,500,000円未満
(2250000, 3500000, NULL, NULL, 'Formula for 2250000-3500000: Add 40.84% of amount exceeding 2,250,000 to base tax'),
-- 3,500,000円を超える金額
(3500000, 999999999, NULL, NULL, 'Special formula for amounts exceeding 3,500,000');

-- 创建触发器函数，用于自动更新 updated_at 字段
-- 注意：函数已在V1脚本中创建，这里不需要再次创建

-- 创建触发器
DROP TRIGGER IF EXISTS update_withholding_tax_bracket_updated_at ON withholding_tax_bracket;
CREATE TRIGGER update_withholding_tax_bracket_updated_at
    BEFORE UPDATE ON withholding_tax_bracket
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

